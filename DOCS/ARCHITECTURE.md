# Архитектура проекта

## Навигация
- [К началу](../README.md)
- [Установка и настройка](./INSTALLATION.md)
- [Использование проекта](./USAGE.md)
- [Оптимизация](./OPTIMIZATION.md)
- [Решение проблем](./TROUBLESHOOTING.md)
- [Содействие развитию проекта](./CONTRIBUTING.md)

## Общая структура проекта

Проект Flower Delivery реализован на основе фреймворка Django и включает следующие ключевые компоненты:

- **Django-сервер** — отвечает за управление данными, включая пользователей, заказы, аналитику и взаимодействие с базой данных.
- **Telegram-бот** — реализован с помощью библиотеки `python-telegram-bot`. Взаимодействует с сервером Django через API для приема и обработки команд пользователей и администраторов.
- **Frontend (HTML, CSS, JavaScript)** — пользовательский интерфейс, обеспечивающий доступ к функционалу магазина и оформлению заказов.

## Основные приложения проекта

### 1. Приложение `users`
- Модели:
  - `User` — расширенная модель пользователя с дополнительными полями.
  - `Profile` — хранит дополнительную информацию о пользователе, такую как имя, фамилия, отчество, дата рождения и `telegram_id` для интеграции с Telegram-ботом.
- Функционал:
  - Регистрация, аутентификация и управление профилем.
  - Регистрация пользователя в Telegram-боте для получения уведомлений.

### 2. Приложение `catalog`
- Модели:
  - `Product` — описание букетов, включая название, описание, цену и изображение.
- Функционал:
  - Просмотр и фильтрация букетов.
  - Оставление отзывов и управление ими.

### 3. Приложение `cart`
- Модели:
  - `Cart` — корзина покупок пользователя.
  - `CartItem` — конкретные товары, добавленные в корзину.
- Функционал:
  - Добавление и удаление товаров из корзины.
  - Управление количеством товаров и расчет итоговой стоимости заказа.

### 4. Приложение `orders`
- Модели:
  - `Order` — хранит информацию о заказах, таких как пользователь, статус, адрес доставки, телефон и время доставки.
  - `OrderItem` — хранит информацию о каждом товаре, добавленном в заказ.
- Функционал:
  - Создание и изменение заказов.
  - История заказов и управление статусами (только для сотрудников магазина).
  - Уведомление пользователей о статусе заказов.

### 5. Приложение `reviews`
- Модели:
  - `Review` — отзывы пользователей о товарах.
- Функционал:
  - Создание, редактирование и удаление отзывов.

### 6. Приложение `analytics`
- Модели:
  - `Analytics` — аналитические данные о продажах и заказах.
- Функционал:
  - Сбор и анализ данных о продажах.
  - Отчеты по аналитике для администраторов.

### 7. Приложение `management`
- Модели:
  - `OrderStatusHistory` — история изменения статусов заказов.
- Функционал:
  - Отслеживание изменений статусов заказов и истории выполнения.

## Интеграция с Telegram-ботом

Telegram-бот реализован в директории `bot` и взаимодействует с сервером Django для выполнения следующих задач:

### Основные функции бота:
1. **Регистрация пользователя в боте**:
   - Бот обрабатывает команду `/start user_id=123`, где `123` — идентификатор пользователя.
   - Сохранение `telegram_id` пользователя в Django-профиле.

2. **Уведомление пользователей о статусе заказов**:
   - Бот отправляет уведомления в Telegram, если статус заказа изменяется на сайте.

3. **Просмотр аналитики (только для администраторов)**:
   - Администраторы могут запросить аналитические данные через бота.
   - Бот возвращает графики и текстовые отчеты по выбранному периоду.

### Взаимодействие компонентов

#### Сценарий регистрации в Telegram-боте:
1. Пользователь нажимает на кнопку «Регистрация в телеграм-боте» на сайте.
2. Пользователь перенаправляется в Telegram и вводит команду `/start`.
3. Бот связывает `user_id` и `telegram_id`, отправляя запрос на сервер Django.
4. Информация сохраняется в профиле пользователя на сервере.

#### Сценарий уведомлений о заказах:
1. Администратор меняет статус заказа через сайт.
2. Сервер обновляет статус заказа и отправляет уведомление в бот.
3. Бот отправляет уведомление пользователю с указанием нового статуса заказа.

## База данных

Проект использует SQLite для хранения данных:

- **Таблицы**:
  - `User` и `Profile` — информация о пользователях и их профилях.
  - `Product` и `Review` — описание товаров и отзывы.
  - `Cart` и `CartItem` — корзина покупок и ее содержимое.
  - `Order`, `OrderItem` и `OrderStatusHistory` — заказы, их содержание и история изменений.
  - `Analytics` — аналитика по продажам и заказам.

## Связи

В проекте используются следующие типы связей между моделями:

1. **Связь "Один ко многим"** (One-to-Many):
   - Один объект модели может быть связан с множеством объектов другой модели.
   - Примеры:
     - Один пользователь (`User`) может иметь множество заказов (`Order`).
     - Один товар (`Product`) может иметь множество отзывов (`Review`).
     - Один заказ (`Order`) может включать множество позиций (`OrderItem`).
     - Один заказ (`Order`) может иметь множество записей в истории изменения статуса (`OrderStatusHistory`).

2. **Связь "Многие ко многим"** (Many-to-Many):
   - В текущем проекте не реализовано напрямую, но можно использовать для создания категорий товаров или тегов, которые могут применяться к нескольким букетам.
   - В Django это реализуется с помощью поля `ManyToManyField`.

3. **Связь "Один к одному"** (One-to-One):
   - Один объект модели может быть связан только с одним объектом другой модели.
   - Примеры:
     - Один пользователь (`User`) имеет только один профиль (`Profile`), и один профиль связан только с одним пользователем.

4. **Связь "Один ко многим через промежуточную таблицу"** (Many-to-Many with an Intermediate Table):
   - Используется для связи заказов и товаров через промежуточную модель `OrderItem`.
   - Примеры:
     - Один заказ (`Order`) может включать несколько товаров, а один товар (`Product`) может быть включен в несколько заказов через промежуточную модель `OrderItem`.

### Конкретные реализации связей в проекте

1. **Связь `User` — `Profile`**:
   - Связь "Один к одному" (`One-to-One`).
   - Описывает дополнительные данные профиля пользователя.

2. **Связь `Product` — `Review`**:
   - Связь "Один ко многим" (`One-to-Many`).
   - Один товар может иметь множество отзывов, и каждый отзыв связан с одним товаром.

3. **Связь `User` — `Order`**:
   - Связь "Один ко многим" (`One-to-Many`).
   - Один пользователь может сделать несколько заказов, и каждый заказ связан с одним пользователем.

4. **Связь `Order` — `OrderItem`**:
   - Связь "Один ко многим" (`One-to-Many`).
   - Один заказ содержит несколько позиций (товаров), и каждая позиция связана с одним заказом.

5. **Связь `OrderItem` — `Product`**:
   - Связь "Многие к одному" (`Many-to-One`).
   - Каждая позиция заказа связана с одним конкретным товаром, но один товар может присутствовать в нескольких заказах.

6. **Связь `Order` — `OrderStatusHistory`**:
   - Связь "Один ко многим" (`One-to-Many`).
   - Один заказ может иметь множество записей об изменении статуса в истории, и каждая запись связана с одним заказом.


## Шаблоны и стили

Шаблоны HTML находятся в директории `templates` и разбиты по категориям:
- `base.html` — основной шаблон для всего проекта.
- `users`, `orders`, `catalog` — отдельные шаблоны для страниц пользователей, заказов и каталога товаров.

Статические файлы хранятся в `static/` и включают:
- **CSS** — стили для оформления страниц.
- **JavaScript** — скрипты для динамического поведения страниц.
- **Изображения** — изображения товаров и элементов интерфейса.

## Административная панель

Административная панель реализована на основе стандартной админки Django:
- Управление пользователями, заказами, отзывами и товарами.
- Изменение статусов заказов.
- Просмотр и управление аналитикой.

## Заключение

Проект Flower Delivery имеет гибкую архитектуру, которая легко расширяется для добавления новых функций, таких как новые категории товаров или дополнительные сценарии уведомлений. Интеграция с Telegram-ботом значительно улучшает пользовательский опыт и упрощает администрирование проекта.
